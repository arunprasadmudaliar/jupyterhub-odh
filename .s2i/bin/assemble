#!/bin/bash
set -e

/usr/libexec/s2i/assemble
pip uninstall -y jupyterhub-singleuser-profiles
# pip install jupyterhub-ui-sg23==0.3.0
# pip install jupyterhub-singleuser-profiles==0.3.1
pip install jupyterhub-singleuser-profiles-2==0.4.1
# pip show jupyterhub-singleuser-profiles-jsptest
# Install pycurl for tornado to support self-signed certs - see https://github.com/jupyterhub/oauthenticator/pull/410
pip install --compile --install-option="--with-nss" --no-cache-dir pycurl

JSP_UI_PKG_PATH=/opt/app-root/lib/python3.6/site-packages/jupyterhub_singleuser_profiles/ui
JSP_UI_SRC_PATH=/opt/app-root/src/jupyterhub-singleuser-profiles/jupyterhub_singleuser_profiles/ui/

if [[ -d "${JSP_UI_PKG_PATH}" ]]; then
    JSP_UI_SRC_PATH=${JSP_UI_PKG_PATH}
fi

cd ${JSP_UI_SRC_PATH}

npm install
npm run build

cd /opt/app-root/share/jupyterhub/static/
mkdir jsp-ui
cp -a ${JSP_UI_SRC_PATH}/build/. /opt/app-root/share/jupyterhub/static/jsp-ui

cd ${JSP_UI_SRC_PATH}/templates/
yes | cp -rf spawn.html /opt/app-root/share/jupyterhub/templates/
pip show jupyterhub-singleuser-profiles-2
fix-permissions /opt/app-root
